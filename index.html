# leaflet mapping
# ongeo MSU activity 4 GTIM
# bryan leahy 6-2024

# Tidyverse 
library(tidyverse)
#Tidy Census is the library that connects to the Census API 
library(tidycensus)
# GGPLOT2
library(ggplot2)
# Hmisc is another library that helps with the data manipulation
library(Hmisc)
# SF is the simple features library that allows you work with the spatial datatype of simple features
library(sf)
# Leaflet Gives the base map
library(leaflet)
# Stringr
library(stringr)
# Allows us to export our leaflet map
library(htmlwidgets)

# census key
census_api_key("29d5debd4dd5e2ddaf21501cf908e4b95aea71ec")

# Loading the Possible Census Variables
ACS<-load_variables(2020,
                    "acs5",
                    cache=FALSE)

# Loading data for variables from census data
Variables<-c(MHI = "B19013_001", # Median Household Income
             MHV = "B25077_001", # Median Home Value
             MAge = "B01002_001", # Median Age
             Totalpop = "B01003_001") # Total Population


# Defining data frame for NYC
# Setting spatial unit to "tract"
NYC_MSACT<-get_acs(geography = "tract",  
                      variables = Variables, #grabbing previously defined variables
                      survey = "acs5",      # ACS 5 year estimates
                      year = 2020,   # End year for the 5 year estimates- 2016-2020
                      output = "wide", # data format wide (cross sectional)
                      state="NY", # Pulling state data for NY
                      county= c("New York","Bronx", "Kings", "Queens", "Richmond"), # Defining the counties in the state that the data will come from
                      geometry=T) # Pulls the spatial data information with it.


# First 10 records/observations return
head(NYC_MSACT)

# summary() provides an overview of the data
summary(NYC_MSACT)


NYC<-NYC_MSACT[,c("GEOID", "NAME", "MHIE", "MHVE", "MAgeE", "TotalpopE", "geometry")]
# Renaming the variables
names(NYC)[names(NYC) =="MHIE"]<-"MHI"
names(NYC)[names(NYC) =="MHVE"]<-"MHV"
names(NYC)[names(NYC) =="MAgeE"]<-"MAge"
names(NYC)[names(NYC) =="TotalpopE"]<-"Totalpop"


### Setting up the color palletes
DpalMHI<-colorQuantile(palette = "viridis", domain=NYC$MHI, n=10)
DpalMHV<-colorQuantile(palette = "RdYlBu", domain=NYC$MHV, n=10)
DpalMAge<-colorQuantile(palette = "magma", domain=NYC$MAge, n=10)
Dpalpop<-colorQuantile(palette = "RdBu", domain=NYC$Totalpop, n=10)


### Leaflet map
NYCmap<-NYC %>% 
  st_transform(crs = "+init=epsg:4326") %>% # Set projection of spatial data frame to match web mapping app
  leaflet() %>%  # Leaflet function 
  setView(lng = -73.96, lat = 40.73, zoom = 10)%>% 
  addTiles(group = "OSM (default)") %>%  #Sets the base map
  #addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
  addProviderTiles(providers$CartoDB.Positron, group = "Carto B") %>%
  addPolygons(group = "Total", #Add polygons is how we choose what we want to map.
              popup = paste("Census Tract: ", NYC$NAME, "<br>", #Pop up info
                            "Total Population: ", NYC$Totalpop, "<br>",   
                            "Median Household Income: ", "$", NYC$MHI, "<br>",
                            "Median Home Value: ", "$", NYC$MHV, "<br>" ,
                            "Median Age: ", NYC$MAge, "yrs old" , "<br>"),
              stroke = FALSE,
              smoothFactor = 0,
              fillOpacity = 0.7,
              color = ~ Dpalpop(Totalpop)) %>% #Color palette
  addLegend(position = "bottomleft", pal=Dpalpop, values= NYC$Totalpop, #Legend for this polygon layer
            title="Percentile of Census Tract Total Population", group = "Total", opacity = 1) %>% 
  addPolygons(group = "MHI", 
              popup = paste("Census Tract: ", NYC$NAME, "<br>",
                            "Total Population: ", NYC$Totalpop, "<br>",
                            "Median Household Income: ", "$", NYC$MHI, "<br>",
                            "Median Home Value: ", "$", NYC$MHV, "<br>",
                            "Median Age: ", NYC$MAge, "yrs old", "<br>"),
              stroke = FALSE,
              smoothFactor = 0,
              fillOpacity = 0.7,
              color = ~ DpalMHI(MHI)) %>%
  addLegend(position = "bottomright", pal=DpalMHI, values= NYC$MHI, 
            title="Percentile of Census Tract Median Household Income", group = "MHI", opacity = 1) %>% 
  addPolygons(group = "MHV",
              popup = paste("Census Tract: ", NYC$NAME, "<br>",
                            "Total Population: ", NYC$Totalpop, "<br>",
                            "Median Household Income: ", "$", NYC$MHI, "<br>",
                            "Median Home Value: ", "$", NYC$MHV, "<br>",
                            "Median Age: ", NYC$MAge, "yrs old" , "<br>"),
              stroke = FALSE,
              smoothFactor = 0,
              fillOpacity = 0.7,
              color = ~ DpalMHV(MHV)) %>%
  addLegend(position = "bottomleft", pal=DpalMHV, values= NYC$MHV, 
            title="Percentile of Census Tract Median Household Income", group = "MHV", opacity = 1) %>% 
 
  addPolygons(group = "MAge", 
              popup = paste("Census Tract: ", NYC$NAME, "<br>", 
                            "Total Population: ", NYC$Totalpop, "<br>",   
                            "Median Household Income: ", "$", NYC$MHI, "<br>",
                            "Median Home Value: ", "$", NYC$MHV, "<br>" ,
                            "Median Age: ", NYC$MAge, "yrs old", "<br>"),
              stroke = FALSE,
              smoothFactor = 0,
              fillOpacity = 0.7,
              color = ~ DpalMAge(MAge)) %>%
  addLegend(position = "bottomleft", pal=DpalMAge, values= NYC$MAge, 
            title="Percentile of Census Tract Median Age", group = "MAge", opacity = 1) %>% 
  
  # Hide three of the groups
  hideGroup("MHI") %>% # Hides the MHI layer so it doesn't all pop up at load
  hideGroup("MHV") %>% # Hides the MHV layer so it all doesn't pop up at the load
  hideGroup("MAge") %>% # Hides the MAge layer so it all doesn't pop up at the load
  addLayersControl(  #Gives option to turn on and off different basemaps or layers.
    baseGroups = c("OSM (default)", "Toner Lite", "Carto B"),
    overlayGroups = c("Total", "MHI", "MHV" , "MAge"),
    options = layersControlOptions(collapsed = FALSE)) 

# load the map
NYCmap 

# Saving the Html map
saveWidget(NYCmap, file="NYCmap.html", selfcontained = T)
